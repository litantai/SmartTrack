name: æ‰¹é‡åˆ›å»º GitHub Issues (Batch Create GitHub Issues)

# ğŸ¯ è§¦å‘æ–¹å¼ï¼šä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ (Manual Trigger Only)
on:
  workflow_dispatch:
    inputs:
      skip_existing:
        description: 'æ˜¯å¦è·³è¿‡å·²å­˜åœ¨çš„ Issue (Skip existing issues)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# ğŸ” æƒé™é…ç½® (Permissions)
permissions:
  issues: write
  contents: read

jobs:
  create-issues:
    name: ä» Markdown æ–‡ä»¶åˆ›å»º Issues
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€å‡ºä»£ç ä»“åº“
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout Repository)
        uses: actions/checkout@v4

      # Step 2: è¯»å– docs/issues/ ç›®å½•ä¸‹çš„æ‰€æœ‰ Markdown æ–‡ä»¶å¹¶åˆ›å»º Issue
      - name: ğŸš€ æ‰¹é‡åˆ›å»º Issues (Create Issues from Markdown Files)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_EXISTING: ${{ github.event.inputs.skip_existing }}
        run: |
          set -e

          # é¢œè‰²å®šä¹‰
          GREEN='\033[0;32m'
          BLUE='\033[0;34m'
          YELLOW='\033[1;33m'
          RED='\033[0;31m'
          NC='\033[0m' # No Color

          echo -e "${BLUE}======================================${NC}"
          echo -e "${BLUE}ğŸ“‹ å¼€å§‹æ‰¹é‡åˆ›å»º GitHub Issues${NC}"
          echo -e "${BLUE}======================================${NC}"
          echo ""

          # åˆ‡æ¢åˆ° docs/issues ç›®å½•
          cd docs/issues

          # ç»Ÿè®¡å˜é‡
          total_files=0
          created_count=0
          skipped_count=0
          failed_count=0

          # éå†æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ’é™¤ README.md å’Œ SUMMARY.mdï¼‰
          for file in *.md; do
            # è·³è¿‡é issue æ–‡ä»¶
            if [[ "$file" == "README.md" || "$file" == "SUMMARY.md" ]]; then
              echo -e "${YELLOW}â­ï¸  è·³è¿‡æ–‡æ¡£æ–‡ä»¶: $file${NC}"
              continue
            fi

            total_files=$((total_files + 1))

            echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${BLUE}ğŸ“„ å¤„ç†æ–‡ä»¶: $file${NC}"

            # ä»æ–‡ä»¶å†…å®¹ä¸­æå– Issue æ ‡é¢˜ï¼ˆç¬¬ä¸€è¡Œçš„ # æ ‡é¢˜ï¼‰
            title=$(head -n 1 "$file" | sed 's/^#\s*//')

            if [[ -z "$title" ]]; then
              echo -e "${RED}âŒ é”™è¯¯: æ— æ³•ä»æ–‡ä»¶ $file æå–æ ‡é¢˜${NC}"
              failed_count=$((failed_count + 1))
              continue
            fi

            echo -e "  ğŸ“Œ æ ‡é¢˜: ${GREEN}$title${NC}"

            # è¯»å–æ–‡ä»¶å…¨éƒ¨å†…å®¹ä½œä¸º Issue body
            body=$(cat "$file")

            # ä»æ–‡ä»¶å†…å®¹ä¸­æå– Labelsï¼ˆæŸ¥æ‰¾ Labels: è¡Œï¼‰
            labels=$(grep -oP '(?<=\*\*Labels\*\*:\s)[\`][^\`]+[\`]' "$file" | tr ',' '\n' | sed 's/`//g' | tr -d ' ' | paste -sd, - || echo "")

            if [[ -z "$labels" ]]; then
              labels="auto-created"
              echo -e "  ğŸ·ï¸  æ ‡ç­¾: ${YELLOW}$labels (é»˜è®¤)${NC}"
            else
              echo -e "  ğŸ·ï¸  æ ‡ç­¾: ${GREEN}$labels${NC}"
            fi

            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ Issue
            if [[ "$SKIP_EXISTING" == "true" ]]; then
              existing_issue=$(gh issue list --state all --search "in:title \"$title\"" --json number,title --jq '.[].number' | head -n 1)

              if [[ -n "$existing_issue" ]]; then
                echo -e "  ${YELLOW}âš ï¸  å·²å­˜åœ¨ Issue #$existing_issueï¼Œè·³è¿‡åˆ›å»º${NC}"
                skipped_count=$((skipped_count + 1))
                continue
              fi
            fi

            # åˆ›å»º Issue
            echo -e "  ${BLUE}ğŸ”„ æ­£åœ¨åˆ›å»º Issue...${NC}"

            if issue_number=$(gh issue create \
              --title "$title" \
              --body "$body" \
              --label "$labels" 2>&1); then

              # æå– Issue ç¼–å·
              issue_num=$(echo "$issue_number" | grep -oP '/issues/\K\d+$' 2>/dev/null || echo "created")
              echo -e "  ${GREEN}âœ… æˆåŠŸåˆ›å»º Issue #$issue_num${NC}"
              created_count=$((created_count + 1))
            else
              echo -e "  ${RED}âŒ åˆ›å»ºå¤±è´¥: $issue_number${NC}"
              failed_count=$((failed_count + 1))
            fi

            echo ""
          done

          # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
          echo -e "${BLUE}======================================${NC}"
          echo -e "${BLUE}ğŸ“Š æ‰§è¡Œç»Ÿè®¡æŠ¥å‘Š${NC}"
          echo -e "${BLUE}======================================${NC}"
          echo -e "  æ€»è®¡å¤„ç†æ–‡ä»¶: ${BLUE}$total_files${NC}"
          echo -e "  âœ… æˆåŠŸåˆ›å»º: ${GREEN}$created_count${NC}"
          echo -e "  â­ï¸  è·³è¿‡: ${YELLOW}$skipped_count${NC}"
          echo -e "  âŒ å¤±è´¥: ${RED}$failed_count${NC}"
          echo -e "${BLUE}======================================${NC}"

          # å¦‚æœæœ‰å¤±è´¥çš„ï¼Œé€€å‡ºç è®¾ä¸º 1
          if [[ $failed_count -gt 0 ]]; then
            echo -e "${RED}âš ï¸  å­˜åœ¨åˆ›å»ºå¤±è´¥çš„ Issueï¼Œè¯·æ£€æŸ¥æ—¥å¿—${NC}"
            exit 1
          fi

          echo -e "${GREEN}ğŸ‰ æ‰€æœ‰ Issue åˆ›å»ºå®Œæˆï¼${NC}"

      # Step 3: è¾“å‡ºåˆ›å»ºçš„ Issues åˆ—è¡¨
      - name: ğŸ“‹ åˆ—å‡ºæ‰€æœ‰ Issues (List All Issues)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "æœ€è¿‘åˆ›å»ºçš„ Issues:"
          gh issue list --limit 20 --json number,title,labels,createdAt --jq '.[] | "  #\(.number) - \(.title) [\(.labels | map(.name) | join(", "))]"'
