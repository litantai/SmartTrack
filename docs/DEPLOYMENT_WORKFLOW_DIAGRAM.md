# SmartTrack 部署工作流图解

## 📊 完整部署流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        SmartTrack 自动化部署流程                           │
└─────────────────────────────────────────────────────────────────────────┘

开发者 👨‍💻
    │
    │ 1. 创建功能分支
    │    git checkout -b feature/xxx
    │
    ▼
┌─────────────────┐
│  功能分支开发      │
│  feature/xxx     │
└─────────────────┘
    │
    │ 2. 提交代码
    │    git push origin feature/xxx
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  创建 Pull Request                                            │
│  ✓ 触发 GitHub Actions                                        │
└──────────────────────────────────────────────────────────────┘
    │
    │ 3. 自动触发
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  GitHub Actions 工作流                                        │
│  ┌────────────────────────────────────────────────────┐      │
│  │ Step 1: Checkout 代码                               │      │
│  │ Step 2: 安装 Node.js 和依赖                         │      │
│  │ Step 3: 安装 Vercel CLI                            │      │
│  │ Step 4: 拉取 Vercel 配置                           │      │
│  │ Step 5: 构建项目 (npm run build)                   │      │
│  │ Step 6: 部署到 Vercel 预览环境                      │      │
│  └────────────────────────────────────────────────────┘      │
│  ⏱️  耗时: 约 4-6 分钟                                        │
└──────────────────────────────────────────────────────────────┘
    │
    │ 4. 部署成功
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  📱 预览环境 (Preview)                                        │
│  ┌────────────────────────────────────────────────────┐      │
│  │  URL: https://smart-track-git-feature-xxx.vercel... │      │
│  │  环境: Preview                                      │      │
│  │  数据库: 测试数据库 (推荐)                           │      │
│  │  生命周期: PR 存在期间                               │      │
│  └────────────────────────────────────────────────────┘      │
│                                                              │
│  🤖 PR 评论中自动发布预览链接                                 │
└──────────────────────────────────────────────────────────────┘
    │
    │ 5. 测试和审查
    │    - 开发者测试功能
    │    - 团队成员代码审查
    │    - 在预览环境验证
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  ✅ PR 审查通过                                               │
│  ✓ 所有测试通过                                               │
│  ✓ 代码审查 Approved                                          │
└──────────────────────────────────────────────────────────────┘
    │
    │ 6. 合并 PR
    │    Merge Pull Request → main
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  main 分支更新                                                │
│  ✓ 再次触发 GitHub Actions                                    │
└──────────────────────────────────────────────────────────────┘
    │
    │ 7. 自动触发生产部署
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  GitHub Actions 工作流 (Production)                           │
│  ┌────────────────────────────────────────────────────┐      │
│  │ Step 1-5: 同预览环境                                │      │
│  │ Step 6: 部署到 Vercel 生产环境 (--prod)             │      │
│  └────────────────────────────────────────────────────┘      │
│  ⏱️  耗时: 约 4-6 分钟                                        │
└──────────────────────────────────────────────────────────────┘
    │
    │ 8. 部署成功
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  🌍 生产环境 (Production)                                     │
│  ┌────────────────────────────────────────────────────┐      │
│  │  URL: https://smart-track-nine.vercel.app          │      │
│  │  环境: Production                                   │      │
│  │  数据库: 生产数据库                                  │      │
│  │  生命周期: 永久                                      │      │
│  └────────────────────────────────────────────────────┘      │
│                                                              │
│  ✨ 用户可以访问最新版本                                      │
└──────────────────────────────────────────────────────────────┘
    │
    │ 9. CDN 缓存更新
    │    ⏱️ 5-10 分钟全球生效
    │
    ▼
┌──────────────────────────────────────────────────────────────┐
│  🌐 全球用户访问                                              │
│  ✓ 功能已上线                                                │
│  ✓ 新版本已部署                                               │
└──────────────────────────────────────────────────────────────┘

```

## 🔄 两种部署环境对比

```
┌──────────────────────────────────────────────────────────────────────┐
│                        预览环境 vs 生产环境                            │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────┐          ┌──────────────────────────┐
│   预览环境 (Preview)       │          │   生产环境 (Production)   │
├──────────────────────────┤          ├──────────────────────────┤
│                          │          │                          │
│ 🎯 目的                   │          │ 🎯 目的                   │
│   测试和审查新功能          │          │   对外提供正式服务          │
│                          │          │                          │
│ 🔗 URL                   │          │ 🔗 URL                   │
│   动态生成               │          │   固定域名                │
│   (每个 PR 独立)          │          │   (smart-track-nine...)  │
│                          │          │                          │
│ 🚀 触发条件               │          │ 🚀 触发条件               │
│   创建/更新 PR            │          │   合并到 main 分支         │
│                          │          │                          │
│ 💾 数据库                │          │ 💾 数据库                │
│   测试数据库 (推荐)        │          │   生产数据库              │
│                          │          │                          │
│ ⏱️  生命周期              │          │ ⏱️  生命周期              │
│   PR 关闭后自动删除        │          │   永久                   │
│                          │          │                          │
│ 👥 访问者                │          │ 👥 访问者                │
│   团队成员，审查者         │          │   所有用户               │
│                          │          │                          │
│ 🔒 安全性                │          │ 🔒 安全性                │
│   可设置密码保护           │          │   公开访问               │
│                          │          │                          │
└──────────────────────────┘          └──────────────────────────┘
```

## ⚙️ GitHub Actions 工作流详解

```
┌──────────────────────────────────────────────────────────────┐
│           GitHub Actions 工作流步骤详解                         │
└──────────────────────────────────────────────────────────────┘

Step 1: Checkout 代码
────────────────────────────────────────────────
  actions/checkout@v4
  ✓ 克隆仓库代码到运行器
  ⏱️ ~10 秒

Step 2: 设置 Node.js 环境
────────────────────────────────────────────────
  actions/setup-node@v4
  ✓ 安装 Node.js 20
  ✓ 配置 npm 缓存
  ⏱️ ~20 秒

Step 3: 安装 Vercel CLI
────────────────────────────────────────────────
  npm install --global vercel@latest
  ✓ 安装最新版 Vercel 命令行工具
  ⏱️ ~30 秒

Step 4: 拉取 Vercel 配置
────────────────────────────────────────────────
  vercel pull --yes --environment=[preview|production]
  ✓ 从 Vercel 拉取项目配置
  ✓ 下载环境变量
  ⏱️ ~10 秒

Step 5: 构建项目
────────────────────────────────────────────────
  vercel build [--prod]
  ✓ 安装依赖 (npm install)
  ✓ 运行 Next.js 构建 (next build)
  ✓ 生成静态文件和服务端代码
  ⏱️ ~2-3 分钟

Step 6: 部署到 Vercel
────────────────────────────────────────────────
  vercel deploy --prebuilt [--prod]
  ✓ 上传构建产物到 Vercel
  ✓ 分配域名
  ✓ 配置 CDN
  ⏱️ ~30-60 秒

Step 7: 发布结果
────────────────────────────────────────────────
  ✓ PR 评论（预览环境）
  ✓ GitHub Actions 摘要
  ⏱️ ~5 秒

──────────────────────────────────────────────────
总计: 约 4-6 分钟
```

## 🔄 回滚流程

```
需要回滚时的操作流程
────────────────────────────────────────────────

方法 1: Vercel 控制台回滚 (推荐)
┌──────────────────────────────────────────┐
│ 1. 登录 Vercel 控制台                     │
│ 2. 进入 SmartTrack 项目                   │
│ 3. 点击 Deployments                       │
│ 4. 找到要回滚到的版本                      │
│ 5. 点击 "Promote to Production"          │
│ ⏱️ 立即生效（< 1 分钟）                    │
└──────────────────────────────────────────┘

方法 2: Git Revert
┌──────────────────────────────────────────┐
│ 1. git revert <commit-hash>              │
│ 2. git push origin main                  │
│ 3. 自动触发新的部署                        │
│ ⏱️ 4-6 分钟（完整构建）                    │
└──────────────────────────────────────────┘
```

## 🚨 故障处理流程

```
部署失败时的排查流程
────────────────────────────────────────────────

❌ 部署失败
    │
    ▼
查看 GitHub Actions 日志
    │
    ├─> 构建失败？
    │   ├─> 检查代码语法
    │   ├─> 检查依赖版本
    │   └─> 本地运行 npm run build 测试
    │
    ├─> Token 问题？
    │   ├─> 检查 VERCEL_TOKEN 是否配置
    │   ├─> 检查 Token 是否过期
    │   └─> 重新创建 Token
    │
    ├─> 环境变量缺失？
    │   ├─> 检查 Vercel 项目设置
    │   ├─> 确认所有必需变量已配置
    │   └─> 检查预览/生产环境配置
    │
    └─> 其他错误？
        ├─> 查看完整日志
        ├─> 搜索错误信息
        └─> 提 Issue 寻求帮助
```

## 📚 相关文档

- [DEPLOYMENT.md](./DEPLOYMENT.md) - 完整部署指南
- [DEPLOYMENT_QUICKSTART.md](./DEPLOYMENT_QUICKSTART.md) - 快速开始
- [DEPLOYMENT_FAQ.md](./DEPLOYMENT_FAQ.md) - 常见问题
- [GITHUB_SECRETS_SETUP.md](./GITHUB_SECRETS_SETUP.md) - Secrets 配置
- [PR5_DEPLOYMENT_EXPLANATION.md](./PR5_DEPLOYMENT_EXPLANATION.md) - PR #5 问题说明

---

**最后更新**: 2026-01-20  
**维护者**: SmartTrack 开发团队
